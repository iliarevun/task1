<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ß–∞—Ç {{ chat_id }}</title>
<style>
body { font-family: system-ui; margin: 0; padding: 0; }
#messages-container {
    height: 90vh;
    overflow-y: scroll;
    padding: 10px;
    border: 1px solid #ccc;
    display: flex;
    flex-direction: column;
}
.message {
    max-width: 60%;
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 10px;
    word-wrap: break-word;
}
.from-self {
    background-color: #c8e6a5; /* —Ç—Ä–æ—Ö–∏ —Ç–µ–º–Ω—ñ—à–∏–π –∑–µ–ª–µ–Ω–∏–π */
    align-self: flex-end;
}
.from-other {
    background-color: #d0d0d0; /* —Ç—Ä–æ—Ö–∏ —Ç–µ–º–Ω—ñ—à–∏–π —Å—ñ—Ä–∏–π */
    align-self: flex-start;
}
    .date-divider {
    text-align: center;
    font-weight: bold;
    color: #444;
    background-color: #e0e0e0;
    display: inline-block;
    padding: 3px 10px;
    border-radius: 12px;
    margin: 10px auto;
    font-size: 0.9em;
}
</style>
</head>
<body>
<h2>–ß–∞—Ç {{ chat_id }}</h2>
<div id="messages-container"></div>

<script>
let chatId = {{ chat_id }};
let oldestId = null;
let newestId = null;
let limit = 50;
let loadingOlder = false;
let loadingNewer = false;

const container = document.getElementById('messages-container');

// ==== helper ====
function sameDay(a, b) {
  return a.getFullYear() === b.getFullYear() &&
         a.getMonth() === b.getMonth() &&
         a.getDate() === b.getDate();
}

function formatDateDivider(dateStr) {
  const date = new Date(dateStr);
  const today = new Date();
  const yesterday = new Date();
  yesterday.setDate(today.getDate() - 1);

  const isSameDay = (d1, d2) =>
    d1.getDate() === d2.getDate() &&
    d1.getMonth() === d2.getMonth() &&
    d1.getFullYear() === d2.getFullYear();

  if (isSameDay(date, today)) return "—Å—å–æ–≥–æ–¥–Ω—ñ";
  if (isSameDay(date, yesterday)) return "–≤—á–æ—Ä–∞";

  // –í —ñ–Ω—à–æ–º—É –≤–∏–ø–∞–¥–∫—É —Ñ–æ—Ä–º–∞—Ç –ø–æ–≤–Ω–∞ –¥–∞—Ç–∞
  return date.toLocaleDateString("uk-UA", {
    day: "numeric",
    month: "long",
    year: "numeric"
  });
}

// ==== —Ñ–∞–±—Ä–∏–∫–∞ –µ–ª–µ–º–µ–Ω—Ç–∞ ====
function createMessageFrag(msg, nextMsg = null) {
  const msgDateObj = new Date(msg.date);
  const msgDateStr = msgDateObj.toDateString();

  const frag = document.createDocumentFragment();

  const div = document.createElement('div');
  div.className = 'message ' + (msg.from_user.is_self ? 'from-self' : 'from-other');
  div.dataset.id = msg.id;
  div.dataset.day = msgDateStr;

  // ---- –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Ö—Ç–æ —ñ –∫–æ–ª–∏)
  let header = `[${msg.date.split('T')[1].slice(0,8)}] ${msg.from_user.first_name || 'Anonymous'}: `;

  // ---- —Ç–µ–∫—Å—Ç/–ø—ñ–¥–ø–∏—Å
  let content = msg.text || "";

  // ---- –ø–µ—Ä–µ—Å–ª–∞–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  if (msg.forwarded) {
    let fwd = "‚Ü™Ô∏è –ü–µ—Ä–µ—Å–ª–∞–Ω–æ ";
    if (msg.forwarded.from_user) {
      fwd += `–≤—ñ–¥ ${msg.forwarded.from_user.first_name || msg.forwarded.from_user.username || "–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á"}`;
    } else if (msg.forwarded.from_chat) {
      fwd += `–∑ —á–∞—Ç—É ${msg.forwarded.from_chat.title || "–Ω–µ–≤—ñ–¥–æ–º–æ"}`;
    }
    content = fwd + (content ? ("\n" + content) : "");
  }

  // ---- –º–µ–¥—ñ–∞ (—Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ/–¥–æ–∫—É–º–µ–Ω—Ç)
 if (msg.media) {
            switch(msg.media.type) {
                case "photo":
                    content += `<br><img src="/file/${msg.media.file_id}" style="max-width:200px; border-radius:8px; margin-top:4px;">`;
                    break;
                case "video":
                    content += `<br><video controls style="max-width:250px; border-radius:8px; margin-top:4px;">
                                    <source src="/file/${msg.media.file_id}" type="video/mp4">
                                </video>`;
                    break;
                case "document":
                    content += `<br>üìé –î–æ–∫—É–º–µ–Ω—Ç: <a href="/file/${msg.media.file_id}" target="_blank">${msg.media.file_name}</a>`;
                    break;
                case "voice":
                    content += `<br><audio controls style="margin-top:4px;">
                                    <source src="/file/${msg.media.file_id}" type="audio/ogg">
                                </audio>`;
                    break;
                case "video_note":
                    content += `<br><video controls autoplay loop muted playsinline
                        style="border-radius:50%; width:200px; height:200px; object-fit:cover; margin-top:4px;">
                                <source src="/file/${msg.media.file_id}" type="video/mp4">
                            </video>`;
                    break;

                case "sticker":
                    content += `<br><img src="/file/${msg.media.file_id}" style="max-width:150px; margin-top:4px;">`;
                    break;
                case "animation": // GIF
                    content += `<br><img src="/file/${msg.media.file_id}" style="max-width:200px; margin-top:4px;">`;
                    break;
                default:
                    content += `<br>üìé –ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø –º–µ–¥—ñ–∞`;
            }
        }


  div.innerHTML = header + content;
  frag.appendChild(div);

  // ---- —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á –¥–∞—Ç–∏
  if (nextMsg) {
    const nextDateObj = new Date(nextMsg.date);
    if (!sameDay(msgDateObj, nextDateObj)) {
      const dateDiv = document.createElement('div');
      dateDiv.className = 'date-divider';
      dateDiv.textContent = formatDateDivider(nextMsg.date);
      frag.appendChild(dateDiv);
    }
  }

  return frag;
}


// ===== –ø–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è =====
async function loadInitialMessages() {
  const resp = await fetch(`/messages/${chatId}?limit=${limit}`);
  const messages = await resp.json();
  if (!messages.length) return;

  messages.sort((a,b) => new Date(a.date) - new Date(b.date)); // —Å—Ç–∞—Ä—ñ –≤–≥–æ—Ä—ñ

  for (let i = 0; i < messages.length; i++) {
    const next = (i < messages.length - 1) ? messages[i+1] : null;
    container.appendChild(createMessageFrag(messages[i], next));
  }

  oldestId = messages[0].id;
  newestId = messages[messages.length - 1].id;
  container.scrollTop = container.scrollHeight;
}

// ===== –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ä—ñ—à–∏—Ö (—Å–∫—Ä–æ–ª –≤–≥–æ—Ä—É) =====
async function loadOlderMessages() {
  if (loadingOlder || !oldestId) return;
  loadingOlder = true;

  const resp = await fetch(`/messages/${chatId}?limit=${limit}&before_id=${oldestId}`);
  const messages = await resp.json();
  if (!messages.length) { loadingOlder = false; return; }

  // –ø—Ä–∏–±–µ—Ä–µ–º–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏
  const existingIds = new Set(Array.from(container.children).map(n => n.dataset?.id).filter(Boolean));
  const newMessages = messages.filter(m => !existingIds.has(String(m.id)));
  if (!newMessages.length) { loadingOlder = false; return; }

  // –í–ê–ñ–õ–ò–í–û: —Ç—Ä–∏–º–∞—î–º–æ —Ö—Ä–æ–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ (—Å—Ç–∞—Ä—ñ‚Üí–Ω–æ–≤—ñ)
  newMessages.sort((a,b) => new Date(a.date) - new Date(b.date));

  const scrollBefore = container.scrollHeight;

  // –ó–±–∏—Ä–∞—î–º–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç –ø–∞–∫–µ—Ç–æ–º —ñ –≤—Å—Ç–∞–≤–ª—è—î–º–æ —Ä–∞–∑–æ–º –ø–µ—Ä–µ–¥ –ø–µ—Ä—à–∏–º –µ–ª–µ–º–µ–Ω—Ç–æ–º
  const batchFrag = document.createDocumentFragment();
  for (let i = 0; i < newMessages.length; i++) {
    const nextInBatch = (i < newMessages.length - 1) ? newMessages[i+1] : null;
    batchFrag.appendChild(createMessageFrag(newMessages[i], nextInBatch));
  }
  container.insertBefore(batchFrag, container.firstChild);

  oldestId = newMessages[0].id;
  container.scrollTop = container.scrollHeight - scrollBefore;
  loadingOlder = false;
}

// ===== –Ω–æ–≤—ñ—à—ñ (–ø–æ–ª—ñ–Ω–≥) =====
async function loadNewerMessages() {
  if (loadingNewer) return;
  loadingNewer = true;

  const resp = await fetch(`/messages/${chatId}?after_id=${newestId || 0}&limit=${limit}`);
  const messages = await resp.json();
  if (!messages.length) { loadingNewer = false; return; }

  // –ø—Ä–∏–±–µ—Ä–µ–º–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏
  const existingIds = new Set(Array.from(container.children).map(n => n.dataset?.id).filter(Boolean));
  const newMessages = messages.filter(m => !existingIds.has(String(m.id)));
  if (!newMessages.length) { loadingNewer = false; return; }

  newMessages.sort((a,b) => new Date(a.date) - new Date(b.date));

  // –¥–æ–¥–∞—î–º–æ –≤ –∫—ñ–Ω–µ—Ü—å, –ø–µ—Ä–µ–¥–∞—é—á–∏ nextMsg –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ—Ä—Ü—ñ—ó
  for (let i = 0; i < newMessages.length; i++) {
    const next = (i < newMessages.length - 1) ? newMessages[i+1] : null;
    container.appendChild(createMessageFrag(newMessages[i], next));
  }

  newestId = newMessages[newMessages.length - 1].id;

  // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª –≤–Ω–∏–∑ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞–π–∂–µ –≤–Ω–∏–∑—É
  if (container.scrollTop + container.clientHeight >= container.scrollHeight - 50) {
    container.scrollTop = container.scrollHeight;
  }

  loadingNewer = false;
}

// —Ç—Ä–∏–≥–µ—Ä–∏
container.addEventListener('scroll', () => {
  if (container.scrollTop < 50) loadOlderMessages();
});

loadInitialMessages();
setInterval(loadNewerMessages, 5000);

</script>

</body>
</html>
